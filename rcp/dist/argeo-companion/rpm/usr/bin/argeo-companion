#!/bin/sh
APP=argeo-companion

JVM=java

# Directories and files
CONF_DIR=/etc/$APP
CONF_DIRS=/etc/$APP/conf.d
BASE_POLICY_ALL=/usr/share/$APP/all.policy
BASE_CONFIG_INI=/usr/share/$APP/config.ini

EXEC_DIR=$HOME/.local/share/argeo-companion
DATA_DIR=$EXEC_DIR/data
CONF_RW=$EXEC_DIR/state
CONFIG_INI=$CONF_RW/config.ini

OSGI_INSTALL_AREA=/usr/share/osgi/boot
OSGI_FRAMEWORK=$OSGI_INSTALL_AREA/org.eclipse.osgi.jar
ECLIPSE_LAUNCHER=$OSGI_INSTALL_AREA/org.eclipse.equinox.launcher.jar

# Overwrite variables
if [ -f $CONF_DIR/settings.sh ];then
	. $CONF_DIR/settings.sh
fi

RETVAL=0

start() {
	mkdir -p $CONF_RW
	mkdir -p $DATA_DIR

    # Merge config files
    printf "## Equinox configuration - Generated by /usr/sbin/nodectl ##\n\n" > $CONFIG_INI
#    cat $BASE_CONFIG_INI >> $CONFIG_INI
    printf "\n##\n## $CONF_DIR/$APP.ini\n##\n\n" >> $CONFIG_INI
    cat $CONF_DIR/$APP.ini >> $CONFIG_INI
    for file in `ls -v $CONF_DIRS/*.ini`; do
            printf "\n##\n## $file\n##\n\n" >> $CONFIG_INI
            cat $file >> $CONFIG_INI
    done;

#		$JAVA_OPTS -jar $OSGI_FRAMEWORK \

	cd $EXEC_DIR
	$JVM \
		-Dlog4j.configuration="file:$CONF_DIR/log4j.properties" \
		-Dosgi.framework=$OSGI_FRAMEWORK \
		$JAVA_OPTS -classpath $ECLIPSE_LAUNCHER	org.eclipse.equinox.launcher.Main \
		-configuration "$CONF_RW" \
		-data "$DATA_DIR"
}

start

